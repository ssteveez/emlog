# emlog pro version 2.3.4 has session(AuthCookie) persistence and any user login vulnerability

emlog is a lightweight blog and CMS system based on PHP and MYSQL.

Project address： https://github.com/emlog/emlog



emlog relies on the AuthCookie field in the cookie to determine whether a user is logged in, but the value is fixed for each user and the same cookie value is used for each login. In addition, in the process of generating AuthCookie, the only unknown variable, Auth_Key, has a default value, which is written in the configuration file. If this value is known, any user login vulnerability can be realized.

## Vulnerability description

The main code to generate the authentication authcookie is as follows: `include\lib\loginauth.php`

![image-20240508193532168](https://img2023.cnblogs.com/blog/1964477/202405/1964477-20240509160202160-1644574732.png)

![image-20240509134816897](https://img2023.cnblogs.com/blog/1964477/202405/1964477-20240509160201760-107627748.png)

![image-20240509135100672](https://img2023.cnblogs.com/blog/1964477/202405/1964477-20240509160201376-748797457.png)



As you can see, the value generated by the AuthCookie is fixed each time

The default value is:

```
EM_AUTHCOOKIE_g8eJOiaZad6RbiIfUFp0dubIeKgIopcB=admin%7C0%7C143040156eec334d605febf210e8f66e
```



The main code to log out is as follows:

![image-20240508193755624](https://img2023.cnblogs.com/blog/1964477/202405/1964477-20240509160200999-92911743.png)

The cookie is destroyed, but the same value is generated each time.



The following code is used to determine whether to log in `  include\lib\loginauth.php`

![image-20240509135603756](https://img2023.cnblogs.com/blog/1964477/202405/1964477-20240509160200635-1640747694.png)

Get the auth_cookie value from the `AUTH_COOKIE_NAME` parameter, and then determine whether it is valid by calling `validateAuthCookie`. The judgment logic is as follows:

![image-20240509141106344](https://img2023.cnblogs.com/blog/1964477/202405/1964477-20240509160200167-551906235.png)

This is roughly the logic of splitting the value of `AUTH_COOKIE_NAME` with `|` and then taking a step to generate the AuthCookie.

As we have analyzed before, these parameter values are fixed during the AuthCookie generation process, so the generated values are the same each time.

So no matter how you exit, the AuthCookie is always available.



Also, if the owner does not change the `Auth_Cookie` in the configuration file when building

![image-20240509143925425](https://img2023.cnblogs.com/blog/1964477/202405/1964477-20240509160159732-1882845413.png)

As long as we know the user name or mailbox, we can generate the AuthCookie of the user, that is to say, any user can log in.

The generation process is as follows:

![image-20240509145608531](https://img2023.cnblogs.com/blog/1964477/202405/1964477-20240509160155148-8850442.png)





## Vulnerablility reproduction



### 1、session(AuthCookie) persistence

First, log in to the admin background

![image-20240509152118646](https://img2023.cnblogs.com/blog/1964477/202405/1964477-20240509160158868-1181178388.png)

In the background management interface, burp is used to capture packets, save packets, and send them to 'Repeater'

![image-20240509152214428](https://img2023.cnblogs.com/blog/1964477/202405/1964477-20240509160158489-1189927923.png)

![image-20240509152246197](https://img2023.cnblogs.com/blog/1964477/202405/1964477-20240509160158033-1774844207.png)



Then log out of the background

![image-20240509152319370](https://img2023.cnblogs.com/blog/1964477/202405/1964477-20240509160157621-705149489.png)

![image-20240509152338865](https://img2023.cnblogs.com/blog/1964477/202405/1964477-20240509160157238-94632606.png)



After logging out, replay the background packet in burp's Repeater:

![image-20240509152444623](https://img2023.cnblogs.com/blog/1964477/202405/1964477-20240509160156693-571020722.png)

You can still access admin managerment.

This indicates that our AuthCookie is always valid.





### 2、any user login

For example, a@a.com user

![image-20240509153253896](https://img2023.cnblogs.com/blog/1964477/202405/1964477-20240509160155621-641806552.png)

We know that the generating logic is as follows:

![image-20240509145608531](https://img2023.cnblogs.com/blog/1964477/202405/1964477-20240509160155148-8850442.png)

Depending on the generation logic, we can generate the user's AUTH COOKIE:

![image-20240509154224948](https://img2023.cnblogs.com/blog/1964477/202405/1964477-20240509160153585-992598352.png)

that is

```
EM_AUTHCOOKIE_g8eJOiaZad6RbiIfUFp0dubIeKgIopcB=a@a.com|0|c7c2d6784f379f6e64288452c621e09c
```



Now, we change the AUTHCOOKIE field in the cookie to this value to log in to the user:

![image-20240509154529416](https://img2023.cnblogs.com/blog/1964477/202405/1964477-20240509160153047-1831925383.png)

Success.